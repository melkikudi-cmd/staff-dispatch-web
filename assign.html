<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assign Workers to Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    .section {
      max-width: 600px;
      margin: 30px auto;
      background: #020617;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1e293b;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #1e293b;
      background: #0f172a;
      color: white;
    }
    button {
      background: #38bdf8;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .link {
      color: #22c55e;
      font-weight: bold;
      word-break: break-all;
    }
    .status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="section">
    <h2>Assign Worker to Event</h2>
    <label for="worker-select">Select Worker:</label>
    <select id="worker-select"></select>

    <label for="event-select">Select Event:</label>
    <select id="event-select"></select>

    <button id="assign-btn">Assign Worker</button>

    <p class="status" id="status"></p>
    <p>Assignment Link: <span class="link" id="assignment-link">-</span></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabaseUrl = 'https://rplmbuoyjlpcxskmtlzk.supabase.co'
    const supabaseKey = 'sb_publishable_Ghw5xJ5IoGL2EzlCHCKLLQ_gWZPryTD'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const workerSelect = document.getElementById('worker-select')
    const eventSelect = document.getElementById('event-select')
    const statusEl = document.getElementById('status')
    const linkEl = document.getElementById('assignment-link')

    async function loadWorkers() {
      const { data: workers, error } = await supabase.from('workers').select('*')
      if (error) { console.error(error); return }
      workers.forEach(w => {
        const option = document.createElement('option')
        option.value = w.id
        option.textContent = w.name
        workerSelect.appendChild(option)
      })
    }

    async function loadEvents() {
      const { data: events, error } = await supabase.from('events').select('*')
      if (error) { console.error(error); return }
      events.forEach(e => {
        const option = document.createElement('option')
        option.value = e.id
        option.textContent = `${e.title} (${e.date})`
        eventSelect.appendChild(option)
      })
    }

    async function assignWorker() {
      const workerId = workerSelect.value
      const eventId = eventSelect.value
      if (!workerId || !eventId) return

      const { data, error } = await supabase.from('worker_assignments').insert([{
        worker_id: workerId,
        event_id: eventId,
        status: 'pending',
        assigned_at: new Date().toISOString()
      }]).single()

      if (error) {
        statusEl.textContent = 'Error assigning worker'
        console.error(error)
        linkEl.textContent = '-'
        return
      }

      statusEl.textContent = 'âœ… Worker assigned successfully!'
      const assignmentLink = `${window.location.origin}/respond.html?id=${data.id}`
      linkEl.textContent = assignmentLink
    }

    document.getElementById('assign-btn').addEventListener('click', assignWorker)

    loadWorkers()
    loadEvents()
  </script>

</body>
</html>
